---
title: "Truffle Monitoring"
author: "Lia Baumann"
date: "2024-03-05"
output: github_document
bibliography: references.json
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Basis

The basis for the research about Truffle Monitoring data is described in detail in these publications:
@molinierFirstIdentificationPolymorphic2013
@molinierSSRbasedIdentificationGenetic2016
@molinierFinescaleGeneticStructure2016
@staubliHiddenFairyRings2022
@steidingerFallSummerTruffle2022
@legendreComparisonMantelTest2010
@kamvarPopprPackageGenetic2014


```{r Tabellen laden, message=FALSE, warning=FALSE, include=FALSE}
library(readxl)
library(knitr)
library(tidyverse)
library(ggplot2)
theme_set(theme_bw())
library(sf)
library(ggspatial)
library(rnaturalearth)
library(envalysis)
library(forcats)
library(poppr)
library(treemap)
library(pegas)
T_all <- read_excel("Tuaest_Master_genMonit_haploid_MP_2024.xlsx")
coord <- read_excel("Koordinaten_2024.xlsx")
```

## Monitoring Sites

```{r Maps laden, echo=FALSE, warning=FALSE}
europe <- ne_countries(scale="medium",returnclass="sf",continent="europe")
europe_points <- st_centroid(europe)
europe_points <- cbind(europe,st_coordinates(st_centroid(europe$geometry)))

ggplot(data=europe) + geom_sf() +
  geom_text(data=europe_points,aes(x=X,y=Y,label = name),
            color = "darkmagenta", fontface = "bold", check_overlap = FALSE) +
  annotation_scale(location = "bl", width_hint = 0.5) +
  #annotation_north_arrow(location = "bl",which_north = "true",
  #                       pad_x = unit(0.5,"in"),pad_y=unit(0.5,"in"),
  #                       style=north_arrow_fancy_orienteering) +
  coord_sf(xlim = c(5.5,11), ylim = c(45.5,48.5), expand = FALSE) +
  geom_point(data=coord,
             aes(x=LON, y=LAT),shape=20,color="darkcyan", fill = "darkcyan",
             pch = 5, size = 3)
```

The dataset was already corrected in the following way:
- Removal of samples with less than 10 markers
- Removal of samples with two mating types.


# Number of samples per Site

```{r erste Datensichtung, echo=FALSE}
# of observations per site
number_obs_all <- as.data.frame(T_all %>%
                                  count(Site_1_abrev))
coord_observ_table <- left_join(number_obs_all,coord,by="Site_1_abrev")
kable(select(coord_observ_table[,1:3 ],c(Site_1_abrev,Site,n)), caption = "Number of observations per site")
```

```{r Data structure per site, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(T_all, aes(x=Sampling_year)) +
  ylab("# of Samples") +
  xlab("Sampling year") +
  scale_x_discrete(limits=c(2010,2016,2021)) +
  geom_bar() +
  facet_wrap(vars(Site_1))
```

Evtl. später:
Standorte mit weniger als 10 Samples werden entfernt.
Dies lässt danach noch folgende Standorte für die Auswertung zu:

```{r Standorte mit weniger als 10 Samples entfernen, include=FALSE}
# of observations per site
T_all_corr1 <- subset(T_all,Site_1_abrev!="BAR")
T_all_corr2 <- subset(T_all_corr1, Site_1_abrev != "GEN")
```

#Idee: alle Observationen auf einer Zeitachse und nach Standort unterteilt anzeigen

```{r all observations, echo=FALSE, message=FALSE, warning=FALSE}

ggplot(T_all) +
  geom_point(aes(x=Sampling_date, y= fct_rev(Site_1_abrev), color = factor(Nb_markers))) +
  scale_colour_brewer(palette= "Greens") +
  theme_publish(base_family = "Times") +
  labs(title = "Overview of samples in truffle monitoring dataset",
       x = "Sampling year", y = "Sampling site abbreviation",
       colour = "Nb_markers")
```

##Clone correction
from https://grunwaldlab.github.io/Population_Genetics_in_R/Population_Strata.html
When dealing with clonal populations, analyses are typically conducted with and without clone correction. Clone correction is a method of censoring a data set such that only one individual per MLG is represented per population (Milgroom, 1996; Grünwald et al., 2003; Grünwald & Hoheisel, 2006). This technique is commonly used with the index of association and genotypic diversity measures since clone corrected populations approximate behavior of sexual populations. Since we want to only observe unique genotypes per population, clone correction requires specification of the stratifications at which clones should be censored. This section will show how to clone correct at a specific stratification and also compare the results with uncorrected data.

Question: Will allelic diversity increase or decrease with clone-censored data?

```{r load genalex data and first examinations, echo=FALSE}
myData <- read.genalex("Daten_Genalex.csv",sep=";")
myData #stratum "Pop" is already defined.
#If I need to include the stratum "Year", I can use the following, would need to include it in the excel file though. Also the treemap will be more interesting once we have more strata.
#splitStrata(myData) <- ~Pop/Year
#monstrata <- strata(myData) %>%
#  group_by(Pop) %>%
#  summarize(count=n())
#monstrata #entspricht aktuell noch der gleichen Tabelle wie "number_obs_all"
#treemap(monstrata, index=nameStrata(myData),vSize="count", type="categorical")
```

Show missing data

```{r missing data, echo=FALSE}
info_table(myData,plot=TRUE)
#for more stuff (removal of individuals or loci etc.): grunwaldlab.github.io/population_genetics_in_r/locus_stats.html
```

Clone correction

```{r clone correction, echo=FALSE}
clonecorrect_data <- clonecorrect(myData, strata=~Pop)
clonecorrect_data
```

```{r compare diversity between corrected and uncorrected, echo=FALSE}
#see grunwaldlab.github.io/population_genetics_in_R/Population_Strata_html
cc <- locus_table(clonecorrect_data, info=FALSE)
mp <- locus_table(myData, info = FALSE)
mp-cc
locus_diff <- mp-cc
barplot(locus_diff[,"1-D"], ylab="Change in Simpson's Index",xlab="Locus", main = "Comparison of clone-corrected vs. uncorrected data")
```


The graph shows a decrease of diversity for most markers when clone-correcting the data (increase of Simpson index means a decrease of genotypic diversity).

```{r poppr stuff}
popdata <- poppr(myData)
popdata
#N = Number of individuals, MLG = Number of multilocus genotypes, eMLG = number of expected MLG at the smallest sample size >= 10 based on rarefaction
#SE = Standard error based on eMLG, H = Shannon-Wiener Index of MLG diversity
#G = Stoddart & Taylor's Index of MLG diversity
# lambda = Simpsons index, E.5 = Evenness, Hexp = Neis Expected Heterozygosity
#Ia = Index of association, rbarD = stand. Index of association
```